<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Abhyudaya</title>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Syne:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-database-compat.js"></script>
    <script src="../firebase-init.js"></script>

    <!-- Load Data -->
    <script src="../data.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #ff6b00;
            --secondary: #d4af37;
            --blue: #1e3a8a;
            --dark: #050505;
            --panel: #111111;
            --light: #ffffff;
            --border: rgba(255, 255, 255, 0.1);
        }

        body {
            background: var(--dark);
            color: var(--light);
            font-family: 'Inter', sans-serif;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 2rem 1rem;
            z-index: 10;
        }

        .logo {
            font-family: 'Syne', sans-serif;
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 2rem;
            padding: 0 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo i {
            color: var(--primary);
            font-size: 2rem;
        }

        .nav-items {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex: 1;
            overflow-y: auto;
        }

        .nav-item {
            padding: 1rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 1rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 107, 0, 0.1);
            color: var(--primary);
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
                height: auto;
                min-height: 100dvh;
                overflow-x: hidden;
                overflow-y: auto;
            }

            .sidebar {
                width: 100%;
                max-width: 100vw;
                border-right: none;
                border-bottom: 1px solid var(--border);
                padding: 0.75rem 0.75rem;
                position: sticky;
                top: 0;
                z-index: 100;
                background: var(--panel);
            }

            .logo {
                display: none;
            }

            .nav-items {
                flex-direction: row;
                overflow-x: auto;
                padding-bottom: 0;
                gap: 0.25rem;
                scrollbar-width: none;
            }

            .nav-items::-webkit-scrollbar {
                display: none;
            }

            .nav-item {
                white-space: nowrap;
                padding: 0.6rem 0.75rem;
                font-size: 0.78rem;
                gap: 0.35rem;
            }

            .main {
                flex: 1;
                min-width: 0;
                overflow-x: hidden;
            }

            .header {
                flex-direction: column;
                align-items: stretch;
                padding: 0.75rem 1rem;
                gap: 0.5rem;
            }

            .header h1 {
                font-size: 1rem;
            }

            .header-actions {
                display: flex;
                gap: 0.5rem;
                width: 100%;
            }

            .header-actions .btn-primary {
                flex: 1;
                justify-content: center;
                padding: 0.6rem 0.5rem;
                font-size: 0.82rem;
            }

            .btn-primary {
                padding: 0.5rem 0.75rem;
                font-size: 0.8rem;
            }

            .content {
                padding: 1rem;
                overflow-x: hidden;
            }

            .card-editor {
                padding: 1.25rem;
            }

            .toggle-wrapper {
                flex-wrap: wrap;
                gap: 0.75rem;
            }
        }

        /* Toggle Switch Styling */
        .toggle-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(255, 107, 0, 0.05);
            padding: 1.5rem;
            border-radius: 1rem;
            border: 1px solid rgba(255, 107, 0, 0.2);
            margin-bottom: 2rem;
            transition: all 0.3s;
        }

        .toggle-wrapper:hover {
            border-color: var(--primary);
            box-shadow: 0 0 20px rgba(255, 107, 0, 0.1);
        }

        .toggle-label {
            font-size: 1.125rem;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .switch-container {
            position: relative;
            display: inline-block;
            width: 70px;
            height: 38px;
        }

        .switch-container input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: 0.4s;
            border-radius: 38px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 28px;
            width: 28px;
            left: 3px;
            bottom: 3px;
            background-color: #bdc3c7;
            transition: 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        input:checked+.slider {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: transparent;
            box-shadow: 0 0 15px rgba(255, 107, 0, 0.4);
        }

        input:checked+.slider:before {
            transform: translateX(32px);
            background-color: white;
        }

        input:focus+.slider {
            box-shadow: 0 0 1px var(--primary);
        }

        /* Main Content */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: radial-gradient(circle at top right, rgba(255, 107, 0, 0.05), transparent 50%),
                radial-gradient(circle at bottom left, rgba(30, 58, 138, 0.05), transparent 50%);
        }

        .header {
            padding: 1.5rem 3rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(17, 17, 17, 0.8);
            backdrop-filter: blur(20px);
            z-index: 10;
        }

        .header h1 {
            font-family: 'Syne', sans-serif;
            font-size: 1.5rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            flex-shrink: 0;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 107, 0, 0.3);
        }

        .content {
            flex: 1;
            padding: 3rem;
            overflow-y: auto;
            position: relative;
        }

        .section-panel {
            display: none;
            animation: fadeIn 0.4s ease;
            max-width: 900px;
            margin: 0 auto;
        }

        .section-panel.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            color: white;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.3s, background 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            background: rgba(255, 255, 255, 0.05);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        .card-editor {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border);
            padding: 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .card-editor h3 {
            margin-bottom: 1.5rem;
            font-family: 'Syne', sans-serif;
            color: var(--secondary);
        }

        /* Image Preview */
        .img-preview {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            background: #222;
        }

        .hint {
            font-size: 0.75rem;
            color: var(--secondary);
            margin-top: 0.25rem;
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
        }

        .add-new-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed var(--border);
            color: white;
            width: 100%;
            padding: 1.5rem;
            border-radius: 1rem;
            cursor: pointer;
            font-size: 1.125rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s;
            margin-bottom: 2rem;
        }

        .add-new-btn:hover {
            background: rgba(255, 107, 0, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }
    </style>
</head>

<body>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <i class="ri-settings-4-fill"></i>
            Admin Panel
        </div>
        <div class="nav-items" id="navItems">
            <div class="nav-item active" data-target="hero"><i class="ri-layout-top-line"></i> Hero Section</div>
            <div class="nav-item" data-target="announcement"><i class="ri-notification-3-line"></i> Flash Notice /
                Announcement</div>
            <div class="nav-item" data-target="uspBanner"><i class="ri-flag-line"></i> USP Banner</div>
            <div class="nav-item" data-target="stats"><i class="ri-bar-chart-box-line"></i> Statistics</div>
            <div class="nav-item" data-target="about"><i class="ri-information-line"></i> About Us</div>
            <div class="nav-item" data-target="programs"><i class="ri-book-open-line"></i> Programs</div>
            <div class="nav-item" data-target="testimonials"><i class="ri-chat-quote-line"></i> Testimonials</div>
            <div class="nav-item" data-target="studentLife"><i class="ri-user-smile-line"></i> Student Life</div>
            <div class="nav-item" data-target="videos"><i class="ri-video-line"></i> Videos (YouTube)</div>
            <div class="nav-item" data-target="gallery"><i class="ri-image-line"></i> Gallery (Photos)</div>
            <div class="nav-item" data-target="contact"><i class="ri-contacts-line"></i> Contact Info</div>
            <div class="nav-item" data-target="contactSubmissions"
                style="background: rgba(239, 68, 68, 0.1); color: #ef4444; margin-top: 1rem; position: relative;">
                <i class="ri-inbox-archive-line"></i> Form Submissions
                <span id="submissionsBadge"
                    style="display:none; position:absolute; right: 1rem; background:#ef4444; color:white; font-size:0.75rem; font-weight:bold; padding: 0.1rem 0.5rem; border-radius:1rem;"></span>
            </div>
            <a href="../index.html" class="nav-item" target="_blank" style="margin-top:auto; text-decoration:none;"><i
                    class="ri-external-link-line"></i> View Website</a>
        </div>
    </div>

    <!-- Main -->
    <div class="main">
        <div class="header">
            <h1 id="pageTitle">Hero Section</h1>
            <div class="header-actions">
                <button class="btn-primary" onclick="window.location.reload()"
                    style="background:transparent; border: 1px solid var(--border);">
                    <i class="ri-refresh-line"></i> Discard
                </button>
                <button class="btn-primary" onclick="saveData()">
                    <i class="ri-save-line"></i> Save Changes
                </button>
            </div>
        </div>
        <div class="content" id="contentArea">
            <!-- Dynamically populated -->
        </div>
    </div>

    <script>
        const STATE = JSON.parse(JSON.stringify(window.SITE_DATA)); // Deep copy for editing

        // Form templates
        const renderInput = (label, path, value, hint = '') => `
            <div class="form-group">
                <label>${label}</label>
                <input type="text" class="form-control" value="${value}" oninput="updateState('${path}', this.value)">
                ${hint ? `<div class="hint">${hint}</div>` : ''}
            </div>
        `;
        const renderTextarea = (label, path, value) => `
            <div class="form-group">
                <label>${label}</label>
                <textarea class="form-control" oninput="updateState('${path}', this.value)">${value}</textarea>
            </div>
        `;
        const renderToggle = (label, path, value) => `
            <div class="toggle-wrapper" onclick="document.getElementById('toggle-${path}').click()">
                <div class="toggle-label">${label}</div>
                <label class="switch-container" onclick="event.stopPropagation()">
                    <input type="checkbox" id="toggle-${path}" ${value ? 'checked' : ''} onchange="updateState('${path}', this.checked)">
                    <span class="slider"></span>
                </label>
            </div>
        `;

        const renderImageUploader = (label, path, value, idPrefix) => `
            <div class="form-group">
                <label>${label}</label>
                <div style="background: rgba(255, 107, 0, 0.05); border: 1px dashed var(--primary); padding: 1.5rem; text-align: center; border-radius: 0.5rem; margin-bottom: 0.5rem; position: relative;" id="upload-box-${idPrefix}">
                    <div id="upload-text-${idPrefix}">
                        <i class="ri-image-add-line" style="font-size: 2rem; color: var(--primary);"></i>
                        <p style="margin-top: 0.5rem; color: rgba(255,255,255,0.7); font-size: 0.875rem;">
                            <strong>Upload directly to ImageKit</strong><br>
                            Click to auto-upload. Files are compressed instantly!
                        </p>
                    </div>
                    <input type="file" accept="image/*" style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0; cursor:pointer;" 
                        onchange="uploadToImageKit(this, '${path}', '${idPrefix}')">
                </div>
                <input type="text" class="form-control" value="${value}" placeholder="Paste ImageKit URL here..."
                    oninput="updateState('${path}', this.value); updateImagePreview('preview-${idPrefix}', this.value)"
                    id="url-${idPrefix}">
            </div>
        `;

        async function uploadToImageKit(inputElement, statePath, idPrefix) {
            const file = inputElement.files[0];
            if (!file) return;

            if (file.size > 25 * 1024 * 1024) {
                alert("File is too large! Please upload files under 25MB.");
                return;
            }

            const uploadTextDiv = document.getElementById('upload-text-' + idPrefix);
            const originalHTML = uploadTextDiv.innerHTML;
            uploadTextDiv.innerHTML = `<i class="ri-loader-4-line ri-spin" style="font-size: 2rem; color: var(--primary);"></i><p style="margin-top: 0.5rem; color: rgba(255,255,255,0.7); font-size: 0.875rem;">Connecting to Cloudflare Secure Auth...</p>`;
            inputElement.style.display = 'none';

            try {
                // 1. Get secure auth signature from Cloudflare Pages Function
                const authRes = await fetch('/api/imagekit-auth');
                if (!authRes.ok) {
                    const errObj = await authRes.json().catch(() => ({}));
                    throw new Error(errObj.error || "Could not fetch secure credentials. Did you set IMAGEKIT_PRIVATE_KEY and IMAGEKIT_PUBLIC_KEY in Cloudflare Pages Settings?");
                }
                const authData = await authRes.json();

                if (!authData.signature || !authData.publicKey) {
                    throw new Error("Invalid Auth parameters returned from Cloudflare.");
                }

                uploadTextDiv.innerHTML = `<i class="ri-loader-4-line ri-spin" style="font-size: 2rem; color: var(--primary);"></i><p style="margin-top: 0.5rem; color: rgba(255,255,255,0.7); font-size: 0.875rem;">Uploading and Compressing...</p>`;

                // 2. Upload to ImageKit using client-side auth
                const formData = new FormData();
                formData.append('file', file);
                formData.append('fileName', file.name);
                formData.append('folder', '/abhyudaya');
                formData.append('publicKey', authData.publicKey);
                formData.append('signature', authData.signature);
                formData.append('expire', authData.expire);
                formData.append('token', authData.token);

                const response = await fetch('https://upload.imagekit.io/api/v1/files/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorResponse = await response.json().catch(() => ({}));
                    throw new Error(errorResponse.message || 'Upload failed due to ImageKit error.');
                }

                const result = await response.json();

                updateState(statePath, result.url);
                updateImagePreview('preview-' + idPrefix, result.url);

                const urlInput = document.getElementById('url-' + idPrefix);
                if (urlInput) urlInput.value = result.url;

            } catch (error) {
                console.error(error);
                alert("Upload Error: " + error.message);
            } finally {
                uploadTextDiv.innerHTML = originalHTML;
                inputElement.style.display = 'block';
                inputElement.value = '';
            }
        }

        function updateState(path, value) {
            const parts = path.split('.');
            let obj = STATE;
            for (let i = 0; i < parts.length - 1; i++) {
                if (!obj[parts[i]]) obj[parts[i]] = {};
                obj = obj[parts[i]];
            }
            obj[parts[parts.length - 1]] = value;
        }

        function updateImagePreview(id, value) {
            const img = document.getElementById(id);
            if (img) img.src = value;
        }

        function deleteItem(path, index) {
            if (confirm('Are you sure you want to delete this item?')) {
                const parts = path.split('.');
                let obj = STATE;
                for (let i = 0; i < parts.length - 1; i++) {
                    obj = obj[parts[i]];
                }
                const targetArray = obj[parts[parts.length - 1]];
                targetArray.splice(index, 1);

                const currentNav = document.querySelector('.nav-item.active').getAttribute('data-target');
                loadSection(currentNav, document.querySelector('.nav-item.active').innerText);
            }
        }

        function addItem(path, defaultTemplate) {
            const parts = path.split('.');
            let obj = STATE;
            for (let i = 0; i < parts.length - 1; i++) {
                obj = obj[parts[i]];
            }
            const targetArray = obj[parts[parts.length - 1]];

            // Deep clone the template
            targetArray.push(JSON.parse(JSON.stringify(defaultTemplate)));

            const currentNav = document.querySelector('.nav-item.active').getAttribute('data-target');
            loadSection(currentNav, document.querySelector('.nav-item.active').innerText);
        }

        const sections = {
            announcement: () => `
                <div class="card-editor">
                    <h3>Top Banner Announcement</h3>
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 2rem; font-size: 0.9rem;">Turn this on to display a prominent flash notice across the top of the website. Useful for Admissions, Holidays, or Breaking News.</p>
                    ${renderToggle('Enable Announcement Banner?', 'announcement.enabled', STATE.announcement?.enabled || false)}
                    ${renderInput('Announcement Text', 'announcement.text', STATE.announcement?.text || "")}
                    ${renderInput('Button Link (e.g. #contact or https://...)', 'announcement.link', STATE.announcement?.link || "")}
                    ${renderInput('Button Text (e.g. Apply Now)', 'announcement.linkText', STATE.announcement?.linkText || "")}
                </div>
            `,
            hero: () => `
                < div class="card-editor" >
                    <h3>Hero Content</h3>
                    ${renderInput('Badge Text', 'hero.badgeText', STATE.hero.badgeText)}
                    ${renderInput('Title Line 1', 'hero.titleLine1', STATE.hero.titleLine1)}
                    ${renderInput('Title Line 2 (Gradient)', 'hero.titleLine2', STATE.hero.titleLine2)}
                    ${renderTextarea('Subtitle', 'hero.subtitle', STATE.hero.subtitle)}
                    ${renderInput('Location', 'hero.location', STATE.hero.location)}
                </div >
                `,
            uspBanner: () => `
                < div class="card-editor" >
                    <h3>USP Banner</h3>
                    ${renderInput('Title Line 1 (Use â€¢ to separate highlight)', 'uspBanner.titleLine1', STATE.uspBanner.titleLine1)}
                    ${renderInput('Title Line 2', 'uspBanner.titleLine2', STATE.uspBanner.titleLine2)}
                    ${renderTextarea('Description', 'uspBanner.description', STATE.uspBanner.description)}
                </div >
                `,
            stats: () => STATE.stats.map((s, i) => `
                < div class="card-editor" >
                    <h3>Stat ${i + 1}</h3>
                    <button class="btn-danger" style="position:absolute; top:1.5rem; right:2rem; margin-top:0;" onclick="deleteItem('stats', ${i})"><i class="ri-delete-bin-line"></i> Delete</button>
                    ${renderInput('Count (Number)', 'stats.' + i + '.count', s.count)}
                    ${renderInput('Label', 'stats.' + i + '.label', s.label)}
                </div >
                `).join('') + `
                < button class="add-new-btn" onclick = 'addItem("stats", {count: 0, label: "New Stat"})' >
                    <i class="ri-add-line"></i> Add New Statistic
            </button >
                `,
            about: () => `
                < div class="card-editor" >
                    <h3>Section Headers</h3>
                    ${renderInput('Tag', 'about.tag', STATE.about.tag)}
                    ${renderInput('Title', 'about.title', STATE.about.title)}
                    ${renderTextarea('Subtitle', 'about.subtitle', STATE.about.subtitle)}
                </div >
                ${STATE.about.cards.map((c, i) => `
                    <div class="card-editor">
                        <h3>Card ${i + 1}</h3>
                        <button class="btn-danger" style="position:absolute; top:1.5rem; right:2rem; margin-top:0;" onclick="deleteItem('about.cards', ${i})"><i class="ri-delete-bin-line"></i> Delete Card</button>
                        ${renderInput('Remix Icon Class (e.g. ri-award-line)', 'about.cards.' + i + '.icon', c.icon)}
                        ${renderInput('Title', 'about.cards.' + i + '.title', c.title)}
                        ${renderTextarea('Description', 'about.cards.' + i + '.description', c.description)}
                    </div>
                `).join('')
                }
            <button class="add-new-btn" onclick='addItem("about.cards", {icon: "ri-star-line", title: "New Feature", description: "Describe the feature..."})'>
                <i class="ri-add-line"></i> Add New Value Card
            </button>
            `,
            programs: () => `
                < div class="card-editor" >
                    <h3>Section Headers</h3>
                    ${renderInput('Tag', 'programs.tag', STATE.programs.tag)}
                    ${renderInput('Title', 'programs.title', STATE.programs.title)}
                    ${renderTextarea('Subtitle', 'programs.subtitle', STATE.programs.subtitle)}
                </div >
                ${STATE.programs.cards.map((c, i) => `
                    <div class="card-editor">
                        <h3>Program ${i + 1}</h3>
                        <button class="btn-danger" style="position:absolute; top:1.5rem; right:2rem; margin-top:0;" onclick="deleteItem('programs.cards', ${i})"><i class="ri-delete-bin-line"></i> Delete</button>
                        ${renderInput('Title', 'programs.cards.' + i + '.title', c.title)}
                        ${renderTextarea('Description', 'programs.cards.' + i + '.description', c.description)}
                    </div>
                `).join('')
                }
            <button class="add-new-btn" onclick='addItem("programs.cards", {title: "New Program", description: "Program details..."})'>
                <i class="ri-add-line"></i> Add New Program
            </button>
            `,
            testimonials: () => STATE.testimonials.map((t, i) => `
                < div class="card-editor" >
                    <h3>Testimonial ${i + 1}</h3>
                    <button class="btn-danger" style="position:absolute; top:1.5rem; right:2rem; margin-top:0;" onclick="deleteItem('testimonials', ${i})"><i class="ri-delete-bin-line"></i> Delete</button>
                    ${renderInput('Initials (Avatar)', 'testimonials.' + i + '.avatar', t.avatar)}
                    ${renderInput('Name', 'testimonials.' + i + '.name', t.name)}
                    ${renderInput('Role', 'testimonials.' + i + '.role', t.role)}
                    ${renderTextarea('Quote', 'testimonials.' + i + '.text', t.text)}
                </div >
                `).join('') + `
                < button class="add-new-btn" onclick = 'addItem("testimonials", {avatar: "A", name: "New Person", role: "Role", text: "Quote..."})' >
                    <i class="ri-add-line"></i> Add New Testimonial
                </button >
                `,
            studentLife: () => STATE.studentLife.map((s, i) => `
                < div class="card-editor" >
                    <h3>Activity ${i + 1}</h3>
                    <button class="btn-danger" style="position:absolute; top:1.5rem; right:2rem; margin-top:0;" onclick="deleteItem('studentLife', ${i})"><i class="ri-delete-bin-line"></i> Delete</button>
                    <img src="${s.image}" class="img-preview" id="preview-life-${i}">
                    ${renderImageUploader('Activity Image', 'studentLife.' + i + '.image', s.image, 'life-' + i)}
                    ${renderInput('Title', 'studentLife.' + i + '.title', s.title)}
                    ${renderTextarea('Description', 'studentLife.' + i + '.description', s.description)}
                </div>
            `).join('') + `
                < button class="add-new-btn" onclick = 'addItem("studentLife", {image: "https://ik.imagekit.io/abhyudaya/default.jpg", title: "New Activity", description: "Description..."})' >
                    <i class="ri-add-line"></i> Add New Activity
                </button >
                `,
            videos: () => STATE.videos.map((v, i) => `
                < div class="card-editor" >
                    <h3>Video Page ${i + 1}</h3>
                    <button class="btn-danger" style="position:absolute; top:1.5rem; right:2rem; margin-top:0;" onclick="deleteItem('videos', ${i})"><i class="ri-delete-bin-line"></i> Delete</button>
                    <img src="${v.thumbnail}" class="img-preview" id="preview-vid-${i}">
                    ${renderImageUploader('Video Thumbnail Image', 'videos.' + i + '.thumbnail', v.thumbnail, 'vid-' + i)}
                    ${renderInput('YouTube Video ID / URL', 'videos.' + i + '.videoId', v.videoId, 'Paste full YouTube URL or just the ID')}
                    ${renderInput('Video Title', 'videos.' + i + '.title', v.title)}
                    ${renderInput('Video Subtitle', 'videos.' + i + '.subtitle', v.subtitle)}
                    <hr style="border-color:var(--border); margin: 1.5rem 0;">
                    <h4>Back of Page Info</h4>
                    ${renderInput('Back Title', 'videos.' + i + '.backTitle', v.backTitle)}
                    ${renderTextarea('Back Description', 'videos.' + i + '.backDesc', v.backDesc)}
                </div>
            `).join('') + `
                <button class="add-new-btn" onclick='addItem("videos", {thumbnail: "https://ik.imagekit.io/abhyudaya/default-thumb.jpg", videoId: "dQw4w9WgXcQ", title: "New Video", subtitle: "Subtitle", backTitle: "Back side", backDesc: "Details on the back of the flip page..."})'>
                    <i class="ri-add-line"></i> Add New Video Page
                </button>
            `,
            gallery: () => STATE.gallery.map((g, i) => `
                <div class="card-editor">
                    <h3>Gallery Image ${i + 1}</h3>
                    <button class="btn-danger" style="position:absolute; top:1.5rem; right:2rem; margin-top:0;" onclick="deleteItem('gallery', ${i})"><i class="ri-delete-bin-line"></i> Delete</button>
                    <img src="${g.image}" class="img-preview" id="preview-gal-${i}">
                    ${renderImageUploader('Gallery Image', 'gallery.' + i + '.image', g.image, 'gal-' + i)}
                    ${renderInput('Title', 'gallery.' + i + '.title', g.title)}
                    ${renderInput('Subtitle', 'gallery.' + i + '.subtitle', g.subtitle)}
                </div>
            `).join('') + `
                <button class="add-new-btn" onclick='addItem("gallery", {image: "https://ik.imagekit.io/abhyudaya/default-gallery.jpg", title: "New Photo", subtitle: "Photo caption"})'>
                    <i class="ri-add-line"></i> Add New Gallery Image
                </button>
            `,
            contact: () => `
                <div class="card-editor">
                    <h3>Contact Information</h3>
                    ${renderInput('Phone Number (Link)', 'contact.phone', STATE.contact.phone)}
                    ${renderInput('Phone Number (Display)', 'contact.phoneDisplay', STATE.contact.phoneDisplay)}
                    ${renderInput('WhatsApp Number (with country code)', 'contact.whatsapp', STATE.contact.whatsapp)}
                    ${renderInput('Email Address', 'contact.email', STATE.contact.email)}
                    ${renderInput('Physical Address', 'contact.address', STATE.contact.address)}
                    ${renderInput('Google Maps Link', 'contact.mapUrl', STATE.contact.mapUrl)}
                    ${renderTextarea('Form Description Text', 'contact.locationDesc', STATE.contact.locationDesc)}
                </div>
            `,
            contactSubmissions: () => `
                <div class="card-editor" id="submissionsContent" style="min-height: 200px;">
                    <div style="text-align:center; padding: 2rem;">
                        <i class="ri-loader-4-line ri-spin" style="font-size: 2rem; color: var(--primary);"></i>
                        <p style="margin-top:1rem; color: var(--secondary);">Securely fetching submissions from Cloudflare...</p>
                    </div>
                </div>
            `
        };

        const contentArea = document.getElementById('contentArea');
        const pageTitle = document.getElementById('pageTitle');

        async function fetchSubmissions() {
            const container = document.getElementById('submissionsContent');
            try {
                if (window.firebaseInitPromise) await window.firebaseInitPromise;
                if (!window.db) {
                    container.innerHTML = "<p style='text-align:center;'>Database is not configured in Cloudflare Environment Variables. Please set up the FIREBASE variables.</p>";
                    return;
                }

                const snapshot = await window.db.ref('contact_submissions').once('value');

                // Clear the unread badge once visited
                const numTotal = snapshot.numChildren();
                localStorage.setItem('abhyudaya_last_seen_submissions', numTotal);
                const badge = document.getElementById('submissionsBadge');
                if (badge) badge.style.display = 'none';

                if (!snapshot.exists()) {
                    container.innerHTML = "<p style='text-align:center; color:rgba(255,255,255,0.7);'>No form submissions found.</p>";
                    return;
                }

                const data = [];
                snapshot.forEach(child => {
                    data.push({ id: child.key, ...child.val() });
                });

                data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                container.innerHTML = data.map(sub => `
                    <div style="background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 0.5rem; padding: 1.5rem; margin-bottom: 1rem; position: relative;">
                        <button onclick="deleteSubmission('${sub.id}')" style="position:absolute; top: 1rem; right: 1rem; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.25rem; padding: 0.25rem 0.5rem; cursor: pointer;">Delete</button>
                        <h4 style="color: var(--primary); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="ri-user-line"></i> ${sub.firstName} ${sub.lastName}
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(min(180px, 100%), 1fr)); gap: 0.75rem; margin-bottom: 1rem; font-size: 0.875rem; color: rgba(255,255,255,0.8);">
                            <div><strong><i class="ri-mail-line"></i> Email:</strong> ${sub.email}</div>
                            <div><strong><i class="ri-phone-line"></i> Phone:</strong> ${sub.phone}</div>
                            <div><strong><i class="ri-book-open-line"></i> Program:</strong> ${sub.program}</div>
                            <div><strong><i class="ri-time-line"></i> Date:</strong> ${new Date(sub.timestamp).toLocaleString()}</div>
                        </div>
                        <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 0.25rem; font-style: italic; color: rgba(255,255,255,0.9);">
                            "${sub.message}"
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                console.error(err);
                container.innerHTML = `<p style="color: #ef4444; text-align:center;">${err.message}.<br><br>Ensure Firebase is initialized correctly.</p>`;
            }
        }

        window.deleteSubmission = async function (id) {
            if (!confirm("Are you sure you want to delete this submission?")) return;
            try {
                if (window.db) {
                    await window.db.ref('contact_submissions/' + id).remove();
                    fetchSubmissions(); // reload
                }
            } catch (err) {
                alert("Error: " + err.message);
            }
        };

        function loadSection(id, title) {
            pageTitle.innerText = title;
            contentArea.innerHTML = `<div class="section-panel active">${sections[id]()}</div>`;

            if (id === 'contactSubmissions') {
                fetchSubmissions();
            }
        }

        // Nav click logic
        document.querySelectorAll('.nav-item').forEach(item => {
            if (!item.hasAttribute('data-target')) return;
            item.addEventListener('click', (e) => {
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                item.classList.add('active');
                loadSection(item.getAttribute('data-target'), item.innerText);
            });
        });

        // Save logic
        function saveData() {
            window.saveSiteData(STATE);
            alert('Changes saved successfully! If Firebase is initialized, it is automatically synced.\n\nYou can now View Website to see the changes.\nOptionally, click OK to download the data.js file.');
            exportData();
        }

        async function checkSubmissionsAlert() {
            if (window.firebaseInitPromise) await window.firebaseInitPromise;
            if (window.db) {
                try {
                    const snapshot = await window.db.ref('contact_submissions').once('value');
                    const count = snapshot.numChildren();
                    const lastSeenCount = parseInt(localStorage.getItem('abhyudaya_last_seen_submissions') || '0', 10);
                    const unreadCount = count - lastSeenCount;

                    if (unreadCount > 0) {
                        const badge = document.getElementById('submissionsBadge');
                        if (badge) {
                            badge.innerText = unreadCount > 99 ? '99+' : unreadCount;
                            badge.style.display = 'inline-block';
                        }

                        // Fire a small toast notification so the admin knows immediately
                        const toast = document.createElement('div');
                        toast.innerHTML = `<i class="ri-mail-unread-line" style="font-size:1.5rem;"></i> You have <b>${unreadCount}</b> new form submissions!`;
                        Object.assign(toast.style, {
                            position: 'fixed', bottom: '2rem', right: '2rem',
                            background: '#ef4444', color: 'white', padding: '1rem 1.5rem',
                            borderRadius: '0.5rem', boxShadow: '0 10px 25px rgba(239, 68, 68, 0.4)',
                            zIndex: '9999', display: 'flex', alignItems: 'center', gap: '0.75rem',
                            transform: 'translateY(100px)', opacity: '0', transition: 'all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)'
                        });
                        document.body.appendChild(toast);

                        setTimeout(() => {
                            toast.style.transform = 'translateY(0)';
                            toast.style.opacity = '1';
                        }, 500);

                        setTimeout(() => {
                            toast.style.transform = 'translateY(100px)';
                            toast.style.opacity = '0';
                            setTimeout(() => toast.remove(), 500);
                        }, 5000);
                    }
                } catch (e) {
                    console.warn("Could not fetch submission count:", e);
                }
            }
        }

        function exportData() {
            const jsContent = `const DEFAULT_SITE_DATA = ${JSON.stringify(STATE, null, 4)
                }; \n\nwindow.SITE_DATA = JSON.parse(localStorage.getItem('abhyudaya_data')) || DEFAULT_SITE_DATA; \n`;

            const dataStr = "data:text/javascript;charset=utf-8," + encodeURIComponent(jsContent);
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "data.js");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // Load initially
        async function initAdmin() {
            if (window.loadDataFromFirebase) {
                contentArea.innerHTML = `<div style="text-align:center; padding: 2rem;"><i class="ri-loader-4-line ri-spin" style="font-size: 2rem; color: var(--primary);"></i><p style="margin-top:1rem; color: var(--secondary);">Syncing data from Firebase...</p></div>`;
                window.SITE_DATA = await window.loadDataFromFirebase();
            }
            // Update the global STATE object that all the form inputs bind to
            Object.assign(STATE, window.SITE_DATA);
            loadSection('hero', 'Hero Section');

            // Trigger contact forms check alert
            checkSubmissionsAlert();
        }

        initAdmin();
    </script>
</body>

</html>